---
layout: post
title: 게임 AI - JPS(Jump Point Search)
categories: [공부 - 게임 AI]
tags: [길찾기 알고리즘]
---

## 개요
***
> 에이스타 알고리즘을 확장한 길찾기 알고리즘인 JPS 알고리즘에 대해 알아보자.

### JPS 알고리즘이란?
***
출발 지점부터 목표지점까지 탐색하는 중간중간에 포인트를 찍어가며 경로를 찾아내는 알고리즘이다.  
에이스타 알고리즘을 확장한 것이며, 성능이 상대적으로 뛰어나다.
## 구현
***
### JPS의 구성
***
> JPS 알고리즘은 어떻게 구성되어 있는지 알아보자

JPS 알고리즘은 에이스타와 길을 찾아내는 방법에서 차이가 있을 뿐이지, 사용되는 노드의 구성은 에이스타와 동일하다. 따라서 이해를 위해선 [에이스타 알고리즘](https://yb970902.github.io/%EA%B3%B5%EB%B6%80%20-%20%EA%B2%8C%EC%9E%84%20ai/2023/06/17/Study-GameAI-Astar.html)을 먼저 이해하고 오길 바란다.  

### JPS 알고리즘의 길찾기 수행
***
> JPS 알고리즘이 어떤 과정을 통해 길을 찾아내는지 알아보자

JPS 알고리즘이 길을 찾아가는 방식은 **체스 게임 속 퀸**의 이동방식을 생각하면 된다.  
퀸은 상하좌우, 대각선 중 한 방향으로 나아갈 수 있다. 하지만 그렇다고 해서 **모든 위치로 한번에 이동할 수 있는것은 아니다.**  
길을 막고있는 장애물이 있거나 한번에 도달할 수 없는 경로인 경우 여러번에 나눠서 이동해야 한다.

퀸이 이동할 수 있는 방향은 다음과 같다.

![JPS_1 image](/assets/images/study/gameAI/JPS/JPS_1.png)

하늘색 네모 타일이 목적지라고 했을때, 다음과 같은 상황에선 퀸은 두 번에 걸쳐서 이동해야 한다.

![JPS_2 image](/assets/images/study/gameAI/JPS/JPS_2.png)

이처럼 목적지까지 이동하기 위해 **경유**해야하는 위치를 찾아내는 방법이 JPS의 핵심이다. 이 경유해야하는 노드를 **포인트** 라고 부른다.  
에이스타는 점진적으로 출발지에서부터 목적지까지의 모든 타일을 하나하나 검색하지만, JPS는 포인트만 빠르게 찾아내어 나아가기 때문에 속도에서 차이가 나는 것이다.

어떻게 차이나는지는 추후에 더 명확하게 설명 할 것이고, 우선 포인트를 찾아내는지 규칙을 알아보자.

#### 포인트를 찾는 규칙

위에서는 퀸이 이동하는 방식을 예로 들었지만, 실제로 JPS에서 지형을 탐색하는 방식은 다르다.  
대각선 탐색을 할 때 **직선 탐색을 추가**로 하는것이 그 차이이다.

![JPS_3 image](/assets/images/study/gameAI/JPS/JPS_3.png)

포인트를 찾는 규칙으로는 세 가지가 있다.

첫 번째 규칙은 **상하좌우로 탐색**할때를 기준으로 한다.  
상하좌우 방향으로 탐색을 하다가 탐색 방향 기준으로 **좌측** 혹은 **우측**에 장애물이 있고, 장애물의 **앞**은 장애물이 없다면 그 곳을 탐색한 지점에 포인트를 찍는다.

위의 설명을 예시를 통해 확인해보자.  
다음은 우측으로 탐색중일때의 모습이다. 파란색 타일은 장애물이고 하얀색은 지나갈 수 있는 영역이며, 동그라미는 탐색을 시작한 지점이다.

![JPS_4 image](/assets/images/study/gameAI/JPS/JPS_4.png)

탐색 방향 기준 **좌측** 혹은 **우측**에 장애물이 있으며, 장애물의 **앞**에 지나갈 수 있는 타일이 있는 곳을 찾아야 한다.  

X표시가 있는 타일이 바로 그 곳이다. X표시의 위 타일은 장애물이지만 우측 상단 타일(붉은색으로 표시)은 장애물이 아니다.

여기에서 잘 보아야 하는 것은 X표시가 생기는 위치이다. 탐색하는 도중 첫 번째 조건에 맞는 상황이라면 **탐색을 한 지점**에 X표시가 생긴다.

![JPS_5 image](/assets/images/study/gameAI/JPS/JPS_5.png)

두 번째 규칙은 **대각선으로 탐색**할때를 기준으로 한다.
대각선 방향으로 탐색을 하다가 탐색 방향 기준 **좌측 하단**에 장애물이 있고, **좌측**은 장애물이 없거나, **우측 하단**에 장애물이 있고, **우측**은 장애물이 없다면 포인트를 찍는다.

마찬가지로 예시를 보며 알아보자.  
우측 상단으로 탐색중일때의 모습이다. 파란색 타일은 장애물이며, 하얀색 타일은 지나갈 수 있는 타일이다.

![JPS_6 image](/assets/images/study/gameAI/JPS/JPS_6.png)

탐색 방향 기준 **좌측 하단**에 장애물이 있고 **좌측**은 장애물이 없거나, **우측 하단**에 장애물이 있고 **우측**은 장애물이 없는 지점을 찾아야 한다.

위의 조건을 만족하는 지점을 찾았다면 포인트를 찍어야 한다. X표시가 있는 타일이 포인트가 찍힌 지점이다.

![JPS_7 image](/assets/images/study/gameAI/JPS/JPS_7.png)

세 번째 규칙은 대각선으로 탐색할때 추가로 탐색하는 **보조 탐색**을 기준으로 한다.  
보조 탐색은 대각선 탐색 중 포인트를 찾지 못했을 때 추가로 하는 탐색이다. 대각선 방향에서 좌우측으로 뻗어나간다.

![JPS_8 image](/assets/images/study/gameAI/JPS/JPS_8.png)

보조탐색이 포인트를 찾는 규칙은 첫 번째 규칙과 동일하게 적용되지만, 포인트를 찍는 위치가 다르다.  
포인트가 찍히는 위치가 보조 탐색을 시작한 지점에 찍히게 된다.

![JPS_9 image](/assets/images/study/gameAI/JPS/JPS_9.png)

세 가지의 포인트를 찾는 규칙에서 공통적으로 적용되는 규칙이 두 가지가 있다.

첫 번째는 탐색은 포인트를 찾았거나, 맵의 끝에 다다랐거나, 장애물로 인해 더이상 탐색이 불가능한 경우 종료된다.

두 번째는 또 탐색도중 목적지를 발견했다면, 포인트를 찍는다.

이제, 위의 규칙대로 탐색했을때 잘 동작하는지 검증해보자.

### JPS 알고리즘의 동작
---

JPS 알고리즘이 Astar 알고리즘을 확장한 알고리즘이기 때문에 기본 구조는 동일하다.  
F, G, H에 대한 설명은 [에이스타 알고리즘](https://yb970902.github.io/%EA%B3%B5%EB%B6%80%20-%20%EA%B2%8C%EC%9E%84%20ai/2023/06/17/Study-GameAI-Astar.html) 설명에서 했으므로 추가로 하진 않겠다.

붉은색 타일은 출발지이고, 푸른색 타일은 목적지이며, 회색 타일은 장애물이다.

![JPS_10 image](/assets/images/study/gameAI/JPS/JPS_10.png)

출발지에서부터 주변 지형을 탐색한다. 출발지는 Close 상태가 된다.

우측 상단 대각선을 탐색하는 도중 포인트를 찍는 조건에 맞았기 때문에 포인트를 찍고, Open 상태로 변경된다.  
이때 OpenList에 들어가는것은 포인트 뿐이고, F, G, H값이 계산되는 것도 포인트뿐인점을 주의깊게 봐야 한다.

또, 대각선 검사에서 포인트를 찍었으므로 보조 검색을 하지 않는다.

![JPS_11 image](/assets/images/study/gameAI/JPS/JPS_11.png)

우측 상단 대각선의 보조검색에서 포인트를 찍을 조건을 찾았기 때문에, 12번 인덱스는 포인트가 된다.

![JPS_12 image](/assets/images/study/gameAI/JPS/JPS_12.png)

이번에도 우측 상단 대각선의 보조검색에서 목적지를 찾았기 때문에 18번 인덱스는 포인트가 된다.

![JPS_13 image](/assets/images/study/gameAI/JPS/JPS_13.png)

우측 탐색에서 목적지를 발견했으므로 목적지인 19번 인덱스는 포인트가 된다.

![JPS_14 image](/assets/images/study/gameAI/JPS/JPS_14.png)

19번 인덱스에서부터 지금까지 탐색했던 오픈 리스트들을 이으면 최적의 경로가 된다.

![JPS_15 image](/assets/images/study/gameAI/JPS/JPS_15.png)

## 마치며
***
길찾기 알고리즘은 에이스타 외에 다양하게 존재한다. 그 중 널리 알려져 있으며, 비교적 내용이 쉬운것이 Astar 알고리즘이다.  
내용을 이해하고, 직접 구현해보면 다른 길찾기 알고리즘을 이해할때 크게 도움이 될 것이다.